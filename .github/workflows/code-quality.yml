name: Code Quality

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  code-quality:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Needed for SonarCloud
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        cd backend && npm ci
        cd ../frontend && npm ci
    
    - name: Run backend code quality checks
      run: |
        cd backend
        npm run lint
        npm run test:coverage
    
    - name: Run frontend code quality checks
      run: |
        cd frontend
        npm run lint
        npm run type-check
        npm run test:unit -- --coverage --run
    
    - name: SonarCloud Scan
      uses: SonarSource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        args: >
          -Dsonar.projectKey=music-collab-platform
          -Dsonar.organization=your-org
          -Dsonar.sources=backend/src,frontend/src
          -Dsonar.tests=backend/src,frontend/src
          -Dsonar.test.inclusions=**/*.test.ts,**/*.spec.ts
          -Dsonar.javascript.lcov.reportPaths=backend/coverage/lcov.info,frontend/coverage/lcov.info
          -Dsonar.coverage.exclusions=**/*.test.ts,**/*.spec.ts,**/coverage/**
    
    - name: Check for security vulnerabilities
      run: |
        cd backend && npm audit --audit-level high
        cd ../frontend && npm audit --audit-level high
    
    - name: Check bundle size (frontend)
      run: |
        cd frontend
        npm run build
        # Check if bundle size is reasonable (under 1MB for main chunk)
        find dist/assets -name "*.js" -exec ls -lh {} \; | awk '{if ($5 > "1M") exit 1}'
